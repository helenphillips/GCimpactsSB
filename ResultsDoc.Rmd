---
title: "GCD MetaAnalysis Results"
author: "Helen Phillips"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}

setwd("C:/Users/helenp/WORK/GCimpactsSB")


library(Hmisc)
library(metafor)
library(ggplot2)
library(dplyr)
library(maptools)
library(ggmap)
library(rnaturalearth)
library(countrycode)
library(viridis)

# devtools::install_github("MathiasHarrer/dmetar")
library(dmetar) # For 3-level I^2

allDat <- read.csv("Data/03_Data/HedgesData_cleaned.csv")
meta <- read.csv("Data/February2022/processed/metadata.csv")

```



# Exploratoration of the data


```{r data0, echo = FALSE}


meta$Country[which(meta$Country == "Czech Rpublic" | meta$Country == "Czechia"  )] <- "Czech Republic"


meta$Country[which(meta$Country == "England" 
                      | meta$Country == "Northern Ireland"
                      | meta$Country == "Scotland"
                      | meta$Country == "the UK"
                      | meta$Country == "United Kingdom"
                      | meta$Country == "Wales")] <- "UK"

meta$Country[which(meta$Country == "United States" 
                   | meta$Country == "United States - Hawaii"
                      | meta$Country == "the US")] <- "USA"

meta$Country[which(meta$Country == "The Netherlands")] <- "Netherlands"
meta$Country[which(meta$Country == "Neherlands")] <- "Netherlands"

meta$Country[grep("Ivoire", meta$Country)] <- "Ivory Coast"

meta$Country[which(meta$Country == "CÃ´teÂ d'Ivoire")] <- "Ivory Coast"
meta$Country[which(meta$Country == "Falkland Islands/Antarctica")] <- "Falkland Islands"


meta <- meta[-which(meta$Country %in% c("Africa",
"Brazil/Uruguay",
"France and Italy"    ,                        
"France, The Netherlands, Switzerland, Canada",
"Ireland, Poland",
"Netherlands, England, Portugal, Germany",
"Portugal,Brazil"   ,
"The Netherlands, UK" ,
"UK, Netherlands, Denmark",
"Sweden, UK, Czech Republic and Greece")),] # Some of these options don't exist though now

meta <- meta[which(meta$Country != ""),]


stud <- meta %>% 
  group_by(Country) %>% 
  summarize(no.stu = n())



# harmonize country names
stud <- stud %>%
  mutate(iso =  countrycode(stud$Country, origin = "country.name", destination = "iso3c")) %>%
  dplyr::group_by(iso) %>%
  summarize(no.stud = sum(no.stu, na.rm = TRUE))


wm <- ne_countries(scale = 110, returnclass = "sf") %>%
  left_join(stud, by = c("adm0_a3" = "iso"))

wm <- sf::st_transform(wm,"+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")

mybreaks <- c(5, 25, 50, 75, 100)

map <- ggplot(wm)+
  geom_sf(aes(fill = (no.stud)))+
  scale_fill_viridis(option = "viridis", 
                     begin = 0,
                     end = 1,
                     na.value = "gray", breaks = mybreaks,
                     name = "Number of\nstudies")+
  theme_bw()+
  theme(legend.position = c(0,0),
        # legend.position = "left",
        legend.justification = c(-0.2, -0.1),
        legend.title = element_text(size=15),
        legend.text = element_text(size=14))

map



# logged for fun

mybreaks <- c(0, 1, 2, 3, 4, 5)

wm$logStud <- log(wm$no.stud + 1)


map <- ggplot(wm)+
  geom_sf(aes(fill = (logStud)))+
  scale_fill_viridis(option = "viridis", 
                     begin = 0,
                     end = 1,
                     na.value = "gray", breaks = mybreaks,
                     name = "ln-Number of\nstudies")+
  theme_bw()+
  theme(legend.position = c(0,0),
        # legend.position = "left",
        legend.justification = c(-0.2, -0.1),
        legend.title = element_text(size=15),
        legend.text = element_text(size=14))

map



```


```{r data1, echo = FALSE}

gcd <- data.frame(gcd = c("LUI", "Fragmentation", "Climate Change", "Pollution", "Nutrient \nEnrichment", "Invasive \nspecies"),
                  total = c(877, 101, 445, 798, 789, 186))

par(mar=c(6, 4, 1, 1))
par(bg=NA)


b <- barplot(gcd$total, space=0.1, ylab = "Number of cases", col = "seagreen")
end_point = 0 + nrow(gcd) + nrow(gcd)-1 #this is the line which does the trick (together with barplot "space = 1" parameter)

text(b[,1], par("usr")[3]-15, 
     srt = 60, adj= c(1, 0.2), xpd = TRUE,
     labels = gcd$gcd, cex=1)


## Taxa groups

taxa <- data.frame(gcd = c("All sizes", "Macro-fauna", "Meso-fauna", "Micro-arthropods", " Micro-fauna"),
                  total = c(141, 1003, 1219, 94, 736))

par(mar=c(6, 4, 1, 1))
par(bg=NA)


b <- barplot(taxa$total, space=0.1, ylab = "Number of cases")
end_point = 0 + nrow(taxa) + nrow(taxa)-1 #this is the line which does the trick (together with barplot "space = 1" parameter)

text(b[,1], par("usr")[3]-15, 
     srt = 60, adj= c(1, 0.2), xpd = TRUE,
     labels = taxa$gcd, cex=1)



```

For a lot/all of the analyses, I have been grouping micro-arthropods with meso-fauna.

I have been including the 'All sizes' category, despite the low number. I have ensured that it is not the intercept level.
I have merged micro-arthropods with meso-fauna.



```{r data2, echo = FALSE}


table(allDat$driver, allDat$Body.Size)


table(allDat$driver, allDat$Measurement)


```
I have removed from the dataset any measurement that didn't fall into these categories, such as evenness measurements, Simpsons, Functional Richness. However, the richness category include all types of richness, e.g., species richness, genus richness and taxa richness. 


# Modelling protocol

All models have (nearly) the same starting structure. I have an interaction between GCD(type) and Body Size, with an additive effect of measurement type.

I then use a QM Test of Moderators to see if the interaction, and then the individual moderators are significant (p < 0.01) and remove them if not. 

All models are fitted with REML, which is better (apparently).


# Global Driver Model

In the main model, I started with a model that contained the interaction between driver and body size, with the additive effect of measurement type.

Body size was not significant in the interaction or as an additive effect only. So was removed from the model.


```{r mainModlod, include = FALSE}
mod.2 <- readRDS(file = "Models/MainMod.rds")

```

```{r mainModres}
summary(mod.2)
```

Intercept is Climate Change and Abundance.

The Test of Moderators output shows that there is a significant difference between the subgroups.


```{r mainmodi}

i2 <- var.comp(mod.2)
summary(i2)
plot(i2)
```

In the output, we can see the percentage of total variance attributable to each of the three levels. The sampling error variance on level 1 is the smallest, making up only roughly 14%. The value of I^2_Level 2, the amount of heterogeneity variance *within* clusters, is higher, totaling roughly 37%. The largest share, however, falls to level 3. Between-cluster (here: between-study) heterogeneity makes up I^2_Level 3 =49% of the total variation in our data.

Overall, this indicates that there is substantial between-study heterogeneity on the third level. Yet, we also see that a large proportion of the total variance, more than one third, can be explained by differences within studies.

```{r mainModPlot, echo = FALSE}
mainmodpred <-predict(mod.2, newmods=rbind(c(0,0,0,0,0,0,0,0), # just the abundance
                           
                             c(1,0,0,0,0,0,0,0),
                       
                             c(0,1,0,0,0,0,0,0),
                           
                             c(0,0,1,0,0,0,0,0),
                            
                             c(0,0,0,1,0,0,0,0),
                        
                             c(0,0,0,0,1,0,0,0)
                             ), addx=TRUE, digits=2) #
slabs <- c("Climate", "Fragmentation", "Invasives", "LUI", "Nutrient", "Pollution")

par(mar=c(5, 8, 1, 1))
forest(mainmodpred$pred, sei=mainmodpred$se, slab=slabs,  xlab="Effect Size", xlim=c(-.4,.7))



measurementPred  <-predict(mod.2, 
                           newmods=rbind(c(0,0,0,0,0,0,0,0), # different measurements for climate
                             c(0,0,0,0,0,1,0,0),
                             c(0,0,0,0,0,0,1,0),
                             c(0,0,0,0,0,0,0,1),
                             c(0,0,1,0,0,0,0,0), 
                            c(0,0,1,0,0,1,0,0), # lui
                             c(0,0,1,0,0,0,1,0),
                             c(0,0,1,0,0,0,0,1)
                             ), addx=TRUE, digits=2) #



slabs <- rep(c("abundance", "biomass", "richness", "shannon"), times = 2)
par(mar=c(5, 8, 1, 1))
forest(measurementPred$pred, sei=measurementPred$se, slab=slabs,  xlab="Effect Size", xlim=c(-.4,.7))
abline(h=4.5, b=0, lty= 2)

mtext("Climate", side = 2, line = 3, at = 6.5)
mtext("LUI", side = 2, line = 3, at = 2.7)


```

The top figure shows the impact of each GCD on the abundance value. 

the bottom figure shows the impact of the different measurement types on Climate and LUI only. I chose these two as for LUI, all are significantly different, and for Climate it shows that the different measurement can cause a significant difference in the response.

I am thinking of a two panel plot like this for the paper. Top showing only abundance and bottom showing the impact of measurement type.


# Climate Change


```{r ClimateModload, include = FALSE}
climate.mod.5 <- readRDS(file = "Models/ClimateMod.rds")

```

```{r ClimateModres}
summary(climate.mod.5)
```

```{r climatemodRes, echo = FALSE}



climatedat <-predict(climate.mod.5, newmods=rbind(c(0,0,0,0),
                                    c(1,0,0,0),
                                    c(0,1,0,0),
                                    c(0,0,1,0),  
                                    c(0,0,0,1)
), addx=TRUE, digits=2) #

slabs <- c("Gas", "Temperature",
           "UVB Radiation", "Water Availability-Drought", "Water Availability-Flood")
par(mar=c(3, 8, 1, 1))
forest(climatedat$pred, sei=climatedat$se, slab=slabs,  xlab="Effect Size", xlim=c(-.4,.7))


```

What is interesting here is that it is only the lack of water that has an impact on soil
fauna. I am surprised by a lack of affect of temperature.

TODO: See if it is always a temperature increase. Maybe need to split temperature into increase/reduce.



# Land Use Intensity


```{r luiModload, include = FALSE}
lui.mod.2 <- readRDS(file = "Models/LUIMod.rds")

```

```{r luiModres}
summary(lui.mod.2)
```

```{r luires, echo = FALSE}


luidat <-predict(lui.mod.2, newmods=rbind(c(0,0,0,0,0,0,0,0,0),
                                              c(0,0,0,0,0,0,1,0,0),
                                              c(0,0,0,0,0,0,0,1,0),
                                              c(0,0,0,0,0,0,0,0,1),  # intercept
                                              
                                              c(1,0,0,0,0,0,0,0,0),
                                              c(1,0,0,0,0,0,1,0,0),
                                              c(1,0,0,0,0,0,0,1,0),
                                              c(1,0,0,0,0,0,0,0,1),# fire
                                              
                                              c(0,1,0,0,0,0,0,0,0),
                                              c(0,1,0,0,0,0,1,0,0),
                                              c(0,1,0,0,0,0,0,1,0),
                                              c(0,1,0,0,0,0,0,0,1),  # grazing   
                                              
                                              c(0,0,1,0,0,0,0,0,0),
                                              c(0,0,1,0,0,0,1,0,0),
                                              c(0,0,1,0,0,0,0,1,0),
                                              c(0,0,1,0,0,0,0,0,1),  # Harvesting
                                              
                                              
                                              c(0,0,0,1,0,0,0,0,0),
                                              c(0,0,0,1,0,0,1,0,0),
                                              c(0,0,0,1,0,0,0,1,0),
                                              c(0,0,0,1,0,0,0,0,1),# Management
                                              
                                              
                                              c(0,0,0,0,1,0,0,0,0),
                                              c(0,0,0,0,1,0,1,0,0),
                                              c(0,0,0,0,1,0,0,1,0),
                                              c(0,0,0,0,1,0,0,0,1), # organic
                                              
                                              c(0,0,0,0,0,1,0,0,0),
                                              c(0,0,0,0,0,1,1,0,0),
                                              c(0,0,0,0,0,1,0,1,0),
                                              c(0,0,0,0,0,1,0,0,1)# tillage
), addx=TRUE, digits=2) #



luidat_abundance <- luidat[c(seq(1, 28, 4)),]

slabs <- c("Degradation", "Fire", "Grazing", "Harvesting", "Management", "Inorganic", "Tillage")
par(mar=c(3, 8, 1, 1))
forest(luidat_abundance$pred, sei=luidat_abundance$se, slab=slabs,  xlab="Effect Size", xlim=c(-.4,.7))



measurement_coefs <- data.frame(meas = c("abundance", "biomass", "richness", "shannon"),
                                coef = c(0, lui.mod.2$beta[8:10]), 
                                ses = c(0, lui.mod.2$se[8:10]))


measurement_coefs <- measurement_coefs[c(4,3,2,1),]

errbar(x =measurement_coefs$meas, y = measurement_coefs$coef, 
      yplus = measurement_coefs$coef + measurement_coefs$ses,
       yminus=measurement_coefs$coef-measurement_coefs$ses, cap=0.015)
abline(v=0, lty =2)

```

The top figure is the impact of different GCD types on the abundance metric only. The bottom figure is how the additive effect of the other measurement types varies (compared to the abundance metric).

# Nutrient Enrichment


```{r nutriModload, include = FALSE}
nutri.mod.2 <- readRDS(file = "Models/nutriMod.rds")

```

```{r nutriModres}
summary(nutri.mod.2)
```

```{r nutriModplot, echo =FALSE}

nutridat <-predict(nutri.mod.2, newmods=rbind(c(0,0,0,0,0,0,0),
                                              # intercept (synthetic Fertilizers)
                                              c(1,0,0,0,0,0,0),
                                              #  "Ca-liming + Wood ash"                                         
                                              c(0,1,0,0,0,0,0),
                                              # Compost
                                              c(0,0,1,0,0,0,0),
                                              # Manure + Slurry 
                                              c(0,0,0,1,0,0,0),
                                              # OMixture
                                              c(0,0,0,0,1,0,0),
                                              # rOther Organic fertilisers
                                              c(0,0,0,0,0,1,0),
                                              # Residue 
                                              c(0,0,0,0,0,0,1)# Sludge 
), addx=TRUE, digits=2) #


slabs <- c("Synthetic Fertilizers", "Ca-liming + Wood ash", "Compost", "Manure + Slurry", "Mixture", 
           "Other Organic fertilisers", "Residue + Mulch", "Sludge")


ord <- c(1, 2, 5, 3,8, 4,  7, 6 )


errbar(x =slabs[ord], y = nutridat$pred[ord], 
       yplus = nutridat$ci.ub[ord],
       yminus=nutridat$ci.lb[ord], 
       cex = 1.5,
       ylab = "Effect Size", 
       xaxt="n")
abline(v=0, lty =2)

# forest(nutridat$pred, sei=nutridat$se, slab=slabs,  xlab="Effect Size", xlim=c(-.4,.7))

```


Take home messages: Most nutrient enrichments have no impact on biodiversity. Those that do (organic fertilisers, 
manure, and mulch) are all ones that can be considered to be soil amendments. i.e. they are 
changing the structure of the soil (as well as adding nutrients). (or the nutrients are slow release??)
So it is more the change in structure that is beneficial, rather than the resource addition.

All organisms benefit from this change in structure, regardless of size.

# Invasive Species



```{r invaModload, include = FALSE}
invas.mod.3 <- readRDS(file = "Models/invasiveMod.rds")
```

Not enough data to look at different measurement types, so I only used the abundance data.

There were no significant variables in the model (GCD type and  body size could be removed). Left with an intercept only model.
Where we can see that there is no significant impact of invasive species on soil fauna.

This lines up with main model, as only biomass showed significant impacts.

```{r invaModres}
summary(invas.mod.3)
```


As I haven't done the habitat fragmentation due to lack of data, I think I would also be tempted to not
look indepth at invasive species either.



# Pollution

For the pollution model, I only used data from Metals and Pesticides (in previous iterations I also used all the data split into different types of pollution, and the results were the same). As these had the best spread of data across the body sizes and the measurement types. 


```{r pollModload, include = FALSE}
poll.mod.1d <- readRDS(file = "Models/pollutionMod.rds")
```


```{r pollModres}
summary(poll.mod.1d)
```


As with the invasive species. There is no significant moderators. However, the intercept is significantly negative (unlike the invasive species.

This lines up with the main model.



# GSBA

Seems a bit strange that body size does not have an effect in any of the models.

So, we can look at some of the taxanomic groups, to see if they have differing response. Acari, Collembola, Earthworms and Nematodes have the most data across the different global change drivers.

I created a model, same structure as previous, with an interaction between the drivers and taxa group, with the additive effect of measurement type.


```{r gsbamod, include=FALSE}

mod.gsba.taxa <- readRDS(file = "Models/GSBAMod.rds")

```

```{r gsbamod2, echo = FALSE}

summary(mod.gsba.taxa)
```

We can plot just the changes in abundance. And because habitat fragmentation and invasive species have the least amount of data, we can also exclude them from the plot.

```{r gsbamodplot, echo = FALSE}

t_dat <-predict(mod.gsba.taxa, newmods=rbind(c(0,0,0,0,0, 0,0,0, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,0,0, 1,0,0, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,0,0, 0,1,0, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,0,0, 0,0,1, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                              # intercept (climate change)
                                              

                                                c(0,0,1,0,0, 0,0,0, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,1,0,0, 1,0,0, 0,0,0, 0,0,1,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,1,0,0, 0,1,0, 0,0,0, 0,0,0,0,0,0,0,1,0,0,0,0,0,0,0),
                                                c(0,0,1,0,0, 0,0,1, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,1,0,0),
                                              # LUI
                                              
                                                c(0,0,0,1,0, 0,0,0, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,1,0, 1,0,0, 0,0,0, 0,0,0,1,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,1,0, 0,1,0, 0,0,0, 0,0,0,0,0,0,0,0,1,0,0,0,0,0,0),
                                                c(0,0,0,1,0, 0,0,1, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,1,0),
                                              # NutrientEnrichment
                                              
                                                c(0,0,0,0,1, 0,0,0, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,0,1, 1,0,0, 0,0,0, 0,0,0,0,1,0,0,0,0,0,0,0,0,0,0),
                                                c(0,0,0,0,1, 0,1,0, 0,0,0, 0,0,0,0,0,0,0,0,0,1,0,0,0,0,0),
                                                c(0,0,0,0,1, 0,0,1, 0,0,0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,1)),
                                              # Pollution 
                   addx=TRUE, digits=2) #

gcds <- rep(c("Climate", "LUI", "Nutrient", "Pollution"), each = 4)
taxa <- rep(c("Acari","Collembola", "Earthworms", "Nematodes"), times = 4)

slabs <- paste(gcds, taxa)

par(mar=c(3, 8, 1, 1))
forest(t_dat$pred, sei=t_dat$se, slab=slabs,  xlab="Effect Size", xlim=c(-.4,.7))


```


# Conclusions

When we can test the effect, there is no impact of body size on any of the models. This is unexpected.

# PRISMA Diagram



```{r prismasetup}

library(PRISMAstatement)

prisma(found = 750,
       found_other = 123,
       no_dupes = 776, 
       screened = 776, 
       screen_exclusions = 13, 
       full_text = 763,
       full_text_exclusions = 17, 
       qualitative = 746, 
       quantitative = 319,
       width = 800, height = 800)

```